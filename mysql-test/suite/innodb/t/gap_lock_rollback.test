--source include/have_innodb.inc
--source include/count_sessions.inc

create table t(k tinyint unsigned primary key) engine=innodb;

insert into t values (60), (70), (80), (90), (100);
insert into t values (160), (170), (180), (190), (200);

begin;
insert into t values (10);
insert into t values (20);
insert into t values (30);
insert into t values (40);
insert into t values (50);

insert into t values (110);
insert into t values (120);
insert into t values (130);
insert into t values (140);
insert into t values (150);

insert into t values (210);
insert into t values (220);
insert into t values (230);
insert into t values (240);
insert into t values (250);

connect (prevent_purge,localhost,root,,);
start transaction with consistent snapshot;

connection default;
rollback;

connect (con1,localhost,root,,);
set transaction isolation level serializable;
begin;
select * from t where k = 40;
select * from t where k = 140;
select * from t where k = 240;

connect (con2,localhost,root,,);
SET session innodb_lock_wait_timeout=1;
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (5);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (45);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (55);

--error ER_LOCK_WAIT_TIMEOUT
insert into t values (105);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (145);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (155);

--error ER_LOCK_WAIT_TIMEOUT
insert into t values (205);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (245);
--error ER_LOCK_WAIT_TIMEOUT
insert into t values (255);

--disconnect con2
--disconnect con1
--disconnect prevent_purge

--connection default
drop table t;
--source include/wait_until_count_sessions.inc
